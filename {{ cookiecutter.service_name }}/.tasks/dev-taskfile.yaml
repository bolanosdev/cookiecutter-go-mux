version: 3

env:
  ENVIRONMENT: dev
  POSTGRES_CONNECTION_STRING: "postgres://{{cookiecutter.postgres_user}}:{{cookiecutter.postgres_password}}@{{cookiecutter.postgres_hostname}}:{{cookiecutter.postgres_port}}/{{cookiecutter.postgres_db}}?sslmode=disable"

tasks:
  secrets: doppler secrets substitute resources/app.yaml --output app.yaml
  migrate_up: "migrate -path internal/db/migrations -database $POSTGRES_CONNECTION_STRING -verbose up"
  migrate_down: "migrate -path internal/db/migrations -database $POSTGRES_CONNECTION_STRING -verbose down"

  run:
    cmds:
      - task clean
      # - task dev:secrets
      - task dev:migrate_up
      - go run main.go start

  build:
    cmds:
      - task build
      - task dev:secrets
      - cp -r app.yaml dist/linux-amd64/app.yaml
